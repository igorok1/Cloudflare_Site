<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Beatbot Mini - –º–æ–±—ñ–ª—å–Ω–∏–π —Å–µ–∫–≤–µ–Ω—Å–æ—Ä</title>
<style>
  :root { --cellBase: 32px; --zoom: 1; --labelW: 80px; --bg:#0f1220; --panel:#171a2b; --muted:#2a2e44; --grid:#232744; --text:#e7ecff; }
  body { margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .app { padding: 8px; }
  header h1 { font-size: 16px; margin: 0; }
  header p { font-size: 12px; margin: 4px 0 8px; color: #cbd3ff; }
  .controls { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
  .btn, .input, input[type=range] { font-size: 12px; }
  .btn { padding: 6px 10px; border-radius: 8px; border: 1px solid var(--muted); background:var(--panel); color:var(--text); }
  .btn:active { transform: translateY(1px); }
  .seq { overflow-x: auto; border: 1px solid var(--muted); border-radius: 10px; }
  .grid { display: grid; grid-template-columns: var(--labelW) repeat(16, calc(var(--cellBase) * var(--zoom))); }
  .rowLabel { font-size: 12px; padding: 4px; background: #12162a; position: sticky; left: 0; z-index: 2; border-right: 1px solid var(--muted); }
  .cell { width: calc(var(--cellBase) * var(--zoom)); height: calc(var(--cellBase) * var(--zoom)); border: 1px solid var(--grid); display: flex; align-items: center; justify-content: center; background:#0f1425; position: relative; }
  .dot { width: calc(0.62 * var(--cellBase) * var(--zoom)); height: calc(0.62 * var(--cellBase) * var(--zoom)); border-radius: 50%; background: #2b2f47; transition: background .12s ease; }
  .cell.active .dot { background: #fff; }
  .cell.playing::after { content:""; position:absolute; inset:0; border-left:2px solid #ff4d4f; background: rgba(255,77,79,.08); }
  @media (max-width: 480px) { :root { --cellBase: 28px; --labelW: 60px; } }

  /* –®—Ç–æ—Ä–∫–∞ */
  .sheet { position: fixed; left: 0; right: 0; bottom: 0; background: var(--panel); border-top: 1px solid var(--muted); border-radius: 12px 12px 0 0; box-shadow: 0 -16px 40px rgba(0,0,0,.45); transform: translateY(100%); transition: transform .2s ease; max-height: 80vh; }
  .sheet.open { transform: translateY(0); }
  .sheet .handle { width: 44px; height: 5px; background: #3a3f61; border-radius: 999px; margin: 8px auto; }
  .sheet .content { padding: 12px; display: grid; gap: 10px; grid-template-columns: 1fr; color:var(--text); }
  .row { display:flex; align-items:center; gap:10px; }
  .row label { font-size: 12px; color:#b8c1ff; }
  .muted { color:#a9b0d9; font-size:12px; }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Beatbot Mini</h1>
    <p>–¢–æ—Ä–∫–Ω–∏—Å—å –∫—Ä–æ–∫—ñ–≤ —ñ –≥—Ä–∞–π. –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω—É. –ö–Ω–æ–ø–∫–∞ –®—Ç–æ—Ä–∫–∞ –≤—ñ–¥–∫—Ä–∏–≤–∞—î –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è.</p>
  </header>
  <div class="controls">
    <button class="btn" id="playBtn">Play</button>
    <button class="btn" id="stopBtn">Stop</button>
    <label class="muted">BPM <input type="range" id="bpm" min="60" max="200" value="140"></label>
    <button class="btn" id="openSheet">–®—Ç–æ—Ä–∫–∞</button>
  </div>
  <div class="seq">
    <div id="grid" class="grid"></div>
  </div>
</div>

<div class="sheet" id="sheet">
  <div class="handle" id="dragHandle"></div>
  <div class="content">
    <div class="row">
      <label>–ú–∞—Å—à—Ç–∞–± —Å—ñ—Ç–∫–∏</label>
      <input type="range" id="zoomRange" min="0.6" max="1.6" step="0.02" value="1">
      <span id="zoomOut" class="muted">100%</span>
    </div>
    <div class="row">
      <label>–ö—Ä–æ–∫—ñ–≤</label>
      <select id="stepsSel">
        <option value="8">8</option>
        <option value="12">12</option>
        <option value="16" selected>16</option>
        <option value="32">32</option>
      </select>
    </div>
    <div class="row">
      <button class="btn" id="randBtn">–†–∞–Ω–¥–æ–º</button>
      <button class="btn" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç–∏</button>
      <button class="btn" id="closeSheet">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
    <p class="muted">–ü—Ä–æ–≤–µ–¥–∏ –≤–Ω–∏–∑ –ø–æ —à—Ç–æ—Ä—Ü—ñ, —â–æ–± –∑–∞–∫—Ä–∏—Ç–∏.</p>
  </div>
</div>

<script>
  // ------------ –î–∞–Ω—ñ —Ç–∞ –≥—Ä—ñ–¥ ------------
  const instruments=[{id:'kick',name:'ü•Å'},{id:'snare',name:'üß®'},{id:'clap',name:'üëè'},{id:'cow',name:'üîî'},{id:'hat',name:'üå´'}];
  let steps=16; let pattern={}; instruments.forEach(i=>pattern[i.id]=Array(steps).fill(0));
  pattern.kick=[1,0,0,0, 0,0,0,0, 1,0,0,0, 0,0,0,0];
  pattern.snare=[0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0];
  pattern.hat=[1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1];

  const gridEl=document.getElementById('grid');
  function updateGridColumns(){ gridEl.style.gridTemplateColumns=`var(--labelW) repeat(${steps}, calc(var(--cellBase) * var(--zoom)))`; }
  function buildGrid(){
    gridEl.innerHTML=''; updateGridColumns();
    instruments.forEach(inst=>{
      const label=document.createElement('div'); label.className='rowLabel'; label.textContent=inst.name; gridEl.appendChild(label);
      for(let i=0;i<steps;i++){
        const c=document.createElement('div'); c.className='cell'; c.dataset.inst=inst.id; c.dataset.step=i; const d=document.createElement('div'); d.className='dot'; c.appendChild(d);
        if(pattern[inst.id][i]) c.classList.add('active');
        c.addEventListener('click',()=>{ pattern[inst.id][i]^=1; c.classList.toggle('active'); },{passive:true});
        gridEl.appendChild(c);
      }
    });
  }

  // ------------ Web Audio ------------
  const AudioCtx=window.AudioContext||window.webkitAudioContext; let ctx; let masterGain; let lookaheadTimer; let startedAt=0; let swing=0.0;
  const transport={ bpm:140, step:0, nextTime:0, isPlaying:false, ahead:0.2, lookahead:25 };
  function initAudio(){ if(!ctx){ ctx=new AudioCtx(); masterGain=ctx.createGain(); masterGain.gain.value=0.85; masterGain.connect(ctx.destination);} }
  function secPerStep(){ const spb=60/transport.bpm; return spb/4; }
  function nextStepTime(t){ const base=secPerStep(); const even=(transport.step%2)===1; return t+base+(even?base*swing:0); }
  function scheduler(){ while(transport.nextTime<ctx.currentTime+transport.ahead){ scheduleStep(transport.step, transport.nextTime); transport.nextTime=nextStepTime(transport.nextTime); transport.step=(transport.step+1)%steps; } lookaheadTimer=setTimeout(scheduler, transport.lookahead); }
  function scheduleStep(idx,time){ highlightColumn(idx,time); instruments.forEach(inst=>{ if(pattern[inst.id]?.[idx]) playInst(inst.id,time); }); }
  function highlightColumn(col,time){ const all=Array.from(document.querySelectorAll('.cell')); const colCells=all.filter(c=>parseInt(c.dataset.step)==col); setTimeout(()=>{ colCells.forEach(c=>c.classList.add('playing')); setTimeout(()=>colCells.forEach(c=>c.classList.remove('playing')), secPerStep()*900); }, Math.max(0,(time-(ctx?ctx.currentTime:0))*1000)); }

  function env(time,dur,peak=1){ const g=ctx.createGain(); g.gain.setValueAtTime(0.0001,time); g.gain.exponentialRampToValueAtTime(peak,time+0.002); g.gain.exponentialRampToValueAtTime(0.0001,time+dur); return g; }
  function noiseBuf(){ const N=ctx.sampleRate*0.5; const b=ctx.createBuffer(1,N,ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<N;i++) d[i]=Math.random()*2-1; return b; }
  function whiteNoise(){ const s=ctx.createBufferSource(); s.buffer=noiseBuf(); return s; }
  function playKick(t){ const o=ctx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(120,t); o.frequency.exponentialRampToValueAtTime(40,t+0.12); const g=env(t,0.25,1.2); o.connect(g).connect(masterGain); o.start(t); o.stop(t+0.3); }
  function playSnare(t){ const s=whiteNoise(); const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.setValueAtTime(1800,t); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.setValueAtTime(600,t); const g=env(t,0.2,0.9); s.connect(bp).connect(hp).connect(g).connect(masterGain); s.start(t); s.stop(t+0.21); }
  function playHat(t){ const s=whiteNoise(); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.setValueAtTime(5000,t); const g=env(t,0.06,0.6); s.connect(hp).connect(g).connect(masterGain); s.start(t); s.stop(t+0.07); }
  function playClap(t){ [0,0.015,0.03].forEach(off=>{ const s=whiteNoise(); const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.setValueAtTime(1200,t+off); const g=env(t+off,0.12,0.7); s.connect(bp).connect(g).connect(masterGain); s.start(t+off); s.stop(t+off+0.13); }); }
  function playCow(t){ const o1=ctx.createOscillator(); o1.type='square'; o1.frequency.setValueAtTime(540,t); const o2=ctx.createOscillator(); o2.type='square'; o2.frequency.setValueAtTime(810,t); const g=env(t,0.25,0.5); const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.setValueAtTime(700,t); o1.connect(bp); o2.connect(bp); bp.connect(g).connect(masterGain); o1.start(t); o2.start(t); o1.stop(t+0.26); o2.stop(t+0.26); }
  function playInst(id,t){ if(id==='kick') return playKick(t); if(id==='snare') return playSnare(t); if(id==='hat') return playHat(t); if(id==='clap') return playClap(t); if(id==='cow') return playCow(t); }

  function play(){ initAudio(); if(transport.isPlaying) return; if(ctx.state==='suspended') ctx.resume(); transport.isPlaying=true; transport.step=0; transport.nextTime=ctx.currentTime+0.06; startedAt=ctx.currentTime; scheduler(); }
  function stop(){ if(!ctx) return; transport.isPlaying=false; clearTimeout(lookaheadTimer); document.querySelectorAll('.cell.playing').forEach(c=>c.classList.remove('playing')); }

  // ------------ UI –ø–æ–¥—ñ—ó ------------
  document.getElementById('playBtn').addEventListener('click', play);
  document.getElementById('stopBtn').addEventListener('click', stop);
  document.getElementById('bpm').addEventListener('input', e=>{ transport.bpm=parseInt(e.target.value,10); });

  // –®—Ç–æ—Ä–∫–∞
  const sheet=document.getElementById('sheet');
  document.getElementById('openSheet').addEventListener('click', ()=> sheet.classList.add('open'));
  document.getElementById('closeSheet').addEventListener('click', ()=> sheet.classList.remove('open'));
  const handle=document.getElementById('dragHandle'); let startY=0, open=false;
  handle.addEventListener('touchstart',e=>{ startY=e.touches[0].clientY; open=sheet.classList.contains('open'); },{passive:true});
  handle.addEventListener('touchmove',e=>{ const dy=e.touches[0].clientY-startY; if(dy>40 && open) sheet.classList.remove('open'); },{passive:true});

  // –ú–∞—Å—à—Ç–∞–± —Ç–∞ –∫—Ä–æ–∫–∏
  const zoomRange=document.getElementById('zoomRange'); const zoomOut=document.getElementById('zoomOut');
  zoomRange.addEventListener('input', e=>{ document.documentElement.style.setProperty('--zoom', e.target.value); zoomOut.textContent=Math.round(e.target.value*100)+'%'; updateGridColumns(); });
  document.getElementById('stepsSel').addEventListener('change', e=>{
    const newSteps=parseInt(e.target.value,10); const resized={}; instruments.forEach(inst=>{ const src=pattern[inst.id]||[]; const next=Array(newSteps).fill(0); for(let i=0;i<Math.min(src.length,newSteps);i++) next[i]=src[i]; resized[inst.id]=next; }); steps=newSteps; pattern=resized; buildGrid(); });
  document.getElementById('randBtn').addEventListener('click', ()=>{ const density={kick:.25,snare:.2,clap:.15,cow:.12,hat:.75}; instruments.forEach(inst=>{ pattern[inst.id]=Array.from({length:steps},()=>Math.random()<(density[inst.id]||.2)?1:0); }); buildGrid(); });
  document.getElementById('clearBtn').addEventListener('click', ()=>{ instruments.forEach(inst=> pattern[inst.id]=Array(steps).fill(0)); buildGrid(); });

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
  buildGrid();
  window.addEventListener('resize', updateGridColumns);
</script>
</body>
</html>
